<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>åŒ—å°å›¾ä¹¦é¦† - 3Dé«˜æ–¯æ¨¡å‹å±•è§ˆ</title>
  <script type="text/javascript" src="js/util.js"></script>
  <link rel="stylesheet" href="css/model_pages.css">

  <script type="importmap">
    {
        "imports": {
            "three": "./lib/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
        }
    }
  </script>

</head>

<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="model-nav">
    <button class="nav-btn back-btn" onclick="openDemo('index', [])">
      <span class="btn-icon">â†</span>
      è¿”å›é¦–é¡µ
    </button>
    
    <div class="scene-title">
      <h2 id="current-scene-title">åŒ—å°å›¾ä¹¦é¦†</h2>
    </div>

    <div class="nav-actions">
      <button class="nav-btn info-btn" onclick="toggleInfoPanel()">
        <span class="btn-icon">â„¹ï¸</span>
        åœºæ™¯ä¿¡æ¯
      </button>
      <button class="nav-btn scenes-btn" onclick="toggleScenesMenu()">
        <span class="btn-icon">ğŸ”</span>
        åˆ‡æ¢åœºæ™¯
      </button>
      <button class="nav-btn navigation-btn" onclick="safeToggleNavigationPanel()">
        <span class="btn-icon">ğŸ—ºï¸</span>
        åœºæ™¯å¯¼èˆª
      </button>
    </div>
  </nav>

  <!-- åœºæ™¯åˆ‡æ¢èœå• -->
  <div id="scenes-menu" class="scenes-menu">
    <div class="menu-content">
      <h3>é€‰æ‹©æ¢ç´¢åŒºåŸŸ</h3>
      <div class="menu-scenes">
        <button class="menu-item" onclick="openDemo('lobby', [['mode', '0']])">
          <span class="menu-icon">ğŸ›ï¸</span>
          å›¾ä¹¦é¦†å¤§å…
        </button>
        <button class="menu-item" onclick="openDemo('reading-area', [['mode', '0']])">
          <span class="menu-icon">ğŸ“š</span>
          é˜…è¯»åŒº
        </button>
        <button class="menu-item" onclick="openDemo('study-area', [['mode', '0']])">
          <span class="menu-icon">ğŸ’»</span>
          è‡ªä¹ åŒº
        </button>
      </div>
    </div>
  </div>

  <!-- ä¿¡æ¯é¢æ¿ -->
  <div id="info-panel" class="info-panel">
    <div class="panel-header">
      <h3>åœºæ™¯ä¿¡æ¯</h3>
      <button class="close-btn" onclick="toggleInfoPanel()">Ã—</button>
    </div>
    <div class="panel-content">
      <div id="scene-info-content">
        <h4 id="info-title">åŒ—å°å›¾ä¹¦é¦†</h4>
        <p id="info-description">è¿™é‡Œæ˜¯åŒ—å°å›¾ä¹¦é¦†çš„3Dé«˜æ–¯æ¨¡å‹å±•ç¤ºã€‚é‡‡ç”¨å…ˆè¿›çš„Gaussian SplattingæŠ€æœ¯ï¼ŒçœŸå®è¿˜åŸå›¾ä¹¦é¦†çš„å»ºç­‘ç©ºé—´å’Œç»†èŠ‚ã€‚</p>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæç¤º -->
  <div class="control-tips">
    <div class="tip-item">
      <span class="tip-key">é¼ æ ‡æ‹–åŠ¨</span>
      <span class="tip-desc">æ—‹è½¬è§†è§’</span>
    </div>
    <div class="tip-item">
      <span class="tip-key">æ»šè½®</span>
      <span class="tip-desc">ç¼©æ”¾</span>
    </div>
    <div class="tip-item">
      <span class="tip-key">å³é”®æ‹–åŠ¨</span>
      <span class="tip-desc">å¹³ç§»</span>
    </div>
    <div class="tip-item">
      <span class="tip-key">ç©ºæ ¼é”®</span>
      <span class="tip-desc">è‡ªåŠ¨å¯¼è§ˆ</span>
    </div>
  </div>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½3Dåœºæ™¯...</p>
  </div>

  <!-- å…ˆåŠ è½½åŸºç¡€å·¥å…· -->
  <script src="js/page-transitions.js"></script>
  <script src="js/performance.js"></script>
  <script src="js/visit-stats.js"></script>

  <!-- ç„¶ååŠ è½½å¯¼èˆªç³»ç»Ÿ -->
  <script src="js/navigation/ViewpointManager.js"></script>
  <script src="js/navigation/NavigationUI.js"></script>
  <script src="js/navigation/AutoTourSystem.js"></script>
  <script src="js/navigation/ViewpointTester.js"></script>

  <!-- é¦–é¡µè§¦å‘è‡ªåŠ¨å¯¼è§ˆ -->
  <script src="js/model_space_tragger.js"></script>


  <!-- æœ€ååŠ è½½å…¶ä»–åŠŸèƒ½ -->
  <script src="js/model_performance_panel.js"></script>
  <script src="js/model_performance_interact_panel.js"></script>
  <script src="js/model_page_KeyboardNav.js"></script>

  
  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';
    import * as THREE from 'three';

    const urlParams = new URLSearchParams(window.location.search);
    const mode = parseInt(urlParams.get('mode')) || 0;

    // æ ¹æ®åœºæ™¯æ¨¡å¼è®¾ç½®ä¸åŒçš„ç›¸æœºå‚æ•°
    const sceneConfigs = {
        0: { // å›¾ä¹¦é¦†å¤§å…
            cameraUp: [	0.01517, -0.99974, -0.01728],
            initialCameraPosition:   [	-3.44732, -0.37301, 0.13657],
            initialCameraLookAt: [	-0.77680, -0.25183, 0.23558]
        },
        1: { // é˜…è¯»åŒº
            cameraUp: [0, -1, -0.54],
            initialCameraPosition: [-2.5, -0.5, -1.0],
            initialCameraLookAt: [1.0, 1.5, 1.0]
        },
        2: { // è‡ªä¹ åŒº
            cameraUp: [0, -1, -0.54],
            initialCameraPosition: [-2.0, -0.3, -1.5],
            initialCameraLookAt: [0.5, 1.0, 0.5]
        }
    };

    const config = sceneConfigs[mode] || sceneConfigs[0];

    const viewer = new GaussianSplats3D.Viewer({
        'cameraUp': config.cameraUp,
        'initialCameraPosition': config.initialCameraPosition,
        'initialCameraLookAt': config.initialCameraLookAt,
        'sphericalHarmonicsDegree': 2
    });

    // æ ¹æ®å½“å‰é¡µé¢åŠ¨æ€è®¾ç½®è·¯å¾„
    const currentScene = window.location.pathname.split('/').pop().replace('.html', '');
    let path = `assets/data/${currentScene}/${currentScene}` + (mode ? '_high' : '') + '.ksplat';
    console.log('ğŸ“ æ¨¡å‹æ–‡ä»¶è·¯å¾„:', path);
    
    // å…¨å±€å˜é‡å£°æ˜
    let viewpointManager;
    let navigationUI;
    let viewpointTester;

    // åˆå§‹åŒ–å¯¼è§ˆç‚¹ç³»ç»Ÿ
    function initViewpointSystem() {
        console.log('ğŸ¯ å¼€å§‹åˆå§‹åŒ–å¯¼è§ˆç‚¹ç³»ç»Ÿ...');
        
        if (viewer) {
            try {
                // åˆå§‹åŒ–å¯¼è§ˆç‚¹ç®¡ç†å™¨
                viewpointManager = new ViewpointManager(viewer);
                window.viewpointManager = viewpointManager;
                
                console.log('âœ… å¯¼è§ˆç‚¹ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');

                // åˆå§‹åŒ–å¯¼èˆªUI
                navigationUI = new NavigationUI(viewpointManager);
                window.navigationUI = navigationUI;
                
                console.log('âœ… å¯¼èˆªUIåˆå§‹åŒ–å®Œæˆ');

                // åˆå§‹åŒ–è‡ªåŠ¨æ¼«æ¸¸ç³»ç»Ÿ
                window.autoTourSystem = new AutoTourSystem(viewpointManager, navigationUI);
                console.log('âœ… è‡ªåŠ¨æ¼«æ¸¸ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

                // åˆå§‹åŒ–æµ‹è¯•å™¨
                viewpointTester = new ViewpointTester(viewpointManager);
                window.viewpointTester = viewpointTester;
                
                console.log('âœ… å¯¼è§ˆç‚¹æµ‹è¯•å™¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ å¯¼è§ˆç‚¹ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
            }
        } else {
            console.error('âŒ æ— æ³•åˆå§‹åŒ–å¯¼è§ˆç‚¹ç³»ç»Ÿ: viewer æœªå®šä¹‰');
        }
    }

    // æ·»åŠ åŠ è½½é”™è¯¯æ˜¾ç¤ºå‡½æ•°
    function showLoadError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            z-index: 10000;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-family: 'Microsoft YaHei', sans-serif;
        `;
        errorDiv.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
            <h3 style="margin: 0 0 1rem 0;">åŠ è½½å¤±è´¥</h3>
            <p style="margin: 0 0 1.5rem 0;">${message}</p>
            <button onclick="location.reload()" style="
                background: white;
                color: #ff6b6b;
                border: none;
                padding: 0.7rem 1.5rem;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
            ">åˆ·æ–°é¡µé¢</button>
        `;
        document.body.appendChild(errorDiv);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.classList.remove('hidden');
        }
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
        }
    }

    // æ›´æ–°åœºæ™¯ä¿¡æ¯
    function updateSceneInfo() {
        const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
        console.log('å½“å‰é¡µé¢:', currentPage);
        
        const sceneConfig = {
            'lobby': {
                title: 'å›¾ä¹¦é¦†å¤§å…',
                description: 'å®ä¼Ÿçš„å›¾ä¹¦é¦†å¤§å…ï¼Œå±•ç°äº†ç°ä»£å»ºç­‘ç¾å­¦ä¸å®ç”¨åŠŸèƒ½çš„å®Œç¾ç»“åˆã€‚è¿™é‡Œæ˜¯è¯»è€…è¿›å…¥çŸ¥è¯†ä¸–ç•Œçš„ç¬¬ä¸€ç«™ï¼Œå®½æ•çš„ç©ºé—´å’Œç²¾å¿ƒè®¾è®¡çš„å…‰çº¿è¥é€ å‡ºåº„é‡è€Œæ¸©é¦¨çš„æ°›å›´ã€‚'
            },
            'reading-area': {
                title: 'é˜…è¯»åŒº',
                description: 'å®‰é™èˆ’é€‚çš„é˜…è¯»åŒºåŸŸï¼Œé…å¤‡ä¸“ä¸šçš„é˜…è¯»ç¯å…‰å’Œç¬¦åˆäººä½“å·¥å­¦çš„åº§æ¤…ã€‚è¿™é‡Œæ˜¯æ·±åº¦é˜…è¯»å’Œæ€è€ƒçš„ç†æƒ³ç©ºé—´ï¼Œé˜³å…‰é€è¿‡çª—æˆ·æ´’åœ¨ä¹¦é¡µä¸Šï¼Œè¥é€ å‡ºå®é™çš„é˜…è¯»ä½“éªŒã€‚'
            },
            'study-area': {
                title: 'è‡ªä¹ åŒº', 
                description: 'åŒ—å°å­¦å­å‹¤å¥‹å­¦ä¹ çš„æ ¸å¿ƒåŒºåŸŸã€‚æ•´é½æ’åˆ—çš„å­¦ä¹ æ¡Œæ¤…ã€å……è¶³çš„ç”µæºæ¥å£å’Œç¨³å®šçš„ç½‘ç»œç¯å¢ƒï¼Œä¸ºå­¦ç”Ÿä»¬æä¾›äº†é«˜æ•ˆçš„å­¦ä¹ ç©ºé—´ã€‚è¿™é‡Œè§è¯äº†æ— æ•°æ¢¦æƒ³çš„å­•è‚²å’Œå®ç°ã€‚'
            }
        };

        const config = sceneConfig[currentPage] || sceneConfig['lobby'];
        
        console.log('æ›´æ–°åœºæ™¯ä¿¡æ¯:', config.title);
        
        document.getElementById('current-scene-title').textContent = config.title;
        document.getElementById('info-title').textContent = config.title;
        document.getElementById('info-description').textContent = config.description;
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ“„ DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åœºæ™¯ä¿¡æ¯');
        updateSceneInfo();
        showLoading();
    });

    // æ¨¡å‹åŠ è½½
    console.log('ğŸ”„ å¼€å§‹åŠ è½½3Dæ¨¡å‹:', path);
    viewer.addSplatScene(path, {
        'progressiveLoad': false
    })
    .then(() => {
        console.log('âœ… 3Dåœºæ™¯åŠ è½½æˆåŠŸ');
        viewer.start();

        // ç¡®ä¿ viewer å¯¹è±¡å…¨å±€å¯ç”¨
        window.viewer = viewer;
        
        console.log('ğŸ¯ Viewer çŠ¶æ€æ£€æŸ¥:', {
            viewer: !!window.viewer,
            startFunction: typeof viewer.start,
            camera: !!viewer.camera,
            position: viewer.getCameraPosition ? 'å¯ç”¨' : 'ä¸å¯ç”¨'
        });
        
        // æ€§èƒ½ç›‘æ§ï¼šåœºæ™¯åŠ è½½å®Œæˆ
        if (window.onSceneLoaded) {
            window.onSceneLoaded();
        }
        
        // è®¿é—®ç»Ÿè®¡ï¼šè®°å½•åœºæ™¯è®¿é—®
        const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
        console.log(`ğŸ“ å½“å‰åœºæ™¯: ${currentPage}`);
        
        if (window.visitStats && typeof window.trackSceneVisit === 'function') {
            window.trackSceneVisit(currentPage);
        } else {
            console.error('âŒ è®¿é—®ç»Ÿè®¡ç³»ç»Ÿæœªå°±ç»ª');
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        hideLoading();
        
        // å»¶è¿Ÿåˆå§‹åŒ–å¯¼è§ˆç‚¹ç³»ç»Ÿï¼Œç¡®ä¿viewerå®Œå…¨å°±ç»ª
        setTimeout(() => {
            try {
                initViewpointSystem();
                console.log('ğŸ‰ æ‰€æœ‰ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('âŒ å¯¼è§ˆç‚¹ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }, 1000);
        
    })
    .catch((error) => {
        console.error('âŒ æ¨¡å‹åŠ è½½å¤±è´¥:', error);
        
        // éšè—åŠ è½½çŠ¶æ€
        hideLoading();
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
        showLoadError('3Dåœºæ™¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    });
  </script>

  <script>
    // å®‰å…¨çš„å¯¼èˆªé¢æ¿åˆ‡æ¢å‡½æ•°
    function safeToggleNavigationPanel() {
        if (typeof navigationUI !== 'undefined' && navigationUI !== null) {
            navigationUI.togglePanel();
        } else {
            console.error('âŒ å¯¼èˆªUIå°šæœªåˆå§‹åŒ–ï¼Œè¯·ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ');
            showTempMessage('å¯¼èˆªåŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...', 'warning');
        }
    }
    
    // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
    function showTempMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'warning' ? 'rgba(255, 213, 59, 0.9)' : 'rgba(79, 172, 254, 0.9)'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            font-family: 'Microsoft YaHei', sans-serif;
        `;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 3000);
    }
    
    // å…¨å±€æµ‹è¯•å‡½æ•°
    window.testGoToViewpoint = (viewpointId) => {
        if (window.viewpointTester) {
            window.viewpointTester.goToViewpoint(viewpointId);
        } else {
            console.error('âŒ viewpointTester æœªåˆå§‹åŒ–');
        }
    };
    
    window.testNextViewpoint = () => {
        if (window.viewpointTester) {
            window.viewpointTester.nextViewpoint();
        } else {
            console.error('âŒ viewpointTester æœªåˆå§‹åŒ–');
        }
    };
    
    window.testPreviousViewpoint = () => {
        if (window.viewpointTester) {
            window.viewpointTester.previousViewpoint();
        } else {
            console.error('âŒ viewpointTester æœªåˆå§‹åŒ–');
        }
    };
    
    window.runAllTests = () => {
        if (window.viewpointTester) {
            window.viewpointTester.runCompleteTestSuite();
        } else {
            console.error('âŒ viewpointTester æœªåˆå§‹åŒ–');
        }
    };

    // å¯¼èˆªå‡½æ•°
    function openDemo(page, params) {
        let url = page + '.html';
        if (params && params.length > 0) {
            let index = 0;
            for (let param of params) {
                url += (index === 0 ? "?" : "&");
                url += param[0] + "=" + param[1];
                index++;
            }
        }
        console.log('ğŸ”— å¯¼èˆªåˆ°:', url);
        window.location.href = url;
    }

    // UIæ§åˆ¶å‡½æ•°
    function toggleInfoPanel() {
        const panel = document.getElementById('info-panel');
        panel.classList.toggle('active');
    }

    function toggleScenesMenu() {
        const menu = document.getElementById('scenes-menu');
        menu.classList.toggle('active');
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•å’Œé¢æ¿
    document.addEventListener('click', function(event) {
        const scenesMenu = document.getElementById('scenes-menu');
        const infoPanel = document.getElementById('info-panel');
        
        if (scenesMenu && scenesMenu.classList.contains('active') && 
            !event.target.closest('.scenes-menu') && 
            !event.target.closest('.scenes-btn')) {
            scenesMenu.classList.remove('active');
        }
        
        if (infoPanel && infoPanel.classList.contains('active') && 
            !event.target.closest('.info-panel') && 
            !event.target.closest('.info-btn')) {
            infoPanel.classList.remove('active');
        }
    });

    
  </script>



<script>
    // æ·»åŠ å…¨å±€åœæ­¢å‡½æ•°
function forceStopAllAutoTours() {
    console.log('ğŸ›‘ å¼ºåˆ¶åœæ­¢æ‰€æœ‰è‡ªåŠ¨å¯¼è§ˆç³»ç»Ÿ');
    
    // åœæ­¢ autoTourSystem
    if (window.autoTourSystem) {
        console.log('ğŸ›‘ åœæ­¢ autoTourSystem');
        window.autoTourSystem.stopAutoTour();
    }
    
    // åœæ­¢ NavigationUI çš„å¯¼è§ˆ
    if (window.navigationUI) {
        console.log('ğŸ›‘ åœæ­¢ navigationUI å¯¼è§ˆ');
        window.navigationUI.stopAutoTour();
    }
    
    // åœæ­¢ autoSpacebarTrigger çš„ç®€å•å¯¼è§ˆ
    if (window.autoSpacebarTrigger) {
        console.log('ğŸ›‘ åœæ­¢ autoSpacebarTrigger å¯¼è§ˆ');
        // å¦‚æœ autoSpacebarTrigger æœ‰åœæ­¢æ–¹æ³•ï¼Œè°ƒç”¨å®ƒ
        if (typeof window.autoSpacebarTrigger.stopAutoTour === 'function') {
            window.autoSpacebarTrigger.stopAutoTour();
        }
    }
    
    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    const maxTimerId = setTimeout(() => {}, 0);
    for (let i = maxTimerId; i > 0; i--) {
        clearTimeout(i);
        clearInterval(i);
    }
    
    console.log('âœ… æ‰€æœ‰è‡ªåŠ¨å¯¼è§ˆå·²å¼ºåˆ¶åœæ­¢');
}

// åœ¨é¡µé¢å¸è½½æ—¶è‡ªåŠ¨åœæ­¢æ‰€æœ‰å¯¼è§ˆ
window.addEventListener('beforeunload', function() {
    console.log('ğŸ“„ é¡µé¢å³å°†å¸è½½ï¼Œåœæ­¢æ‰€æœ‰è‡ªåŠ¨å¯¼è§ˆ');
    forceStopAllAutoTours();
});

// æ·»åŠ è°ƒè¯•å‘½ä»¤åˆ°å…¨å±€
window.debugAutoTour = function() {
    console.log('ğŸ” è‡ªåŠ¨å¯¼è§ˆè°ƒè¯•ä¿¡æ¯:');
    console.log('- autoTourSystem:', window.autoTourSystem ? window.autoTourSystem.getStatus() : 'æœªå®šä¹‰');
    console.log('- navigationUI:', window.navigationUI ? { 
        isAutoTourRunning: window.navigationUI.isAutoTourRunning,
        tourInterval: !!window.navigationUI.tourInterval
    } : 'æœªå®šä¹‰');
    console.log('- autoSpacebarTrigger:', window.autoSpacebarTrigger ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
};

// æ·»åŠ å¼ºåˆ¶åœæ­¢å‘½ä»¤åˆ°å…¨å±€
window.stopAllTours = forceStopAllAutoTours;
</script>



</body>
</html>